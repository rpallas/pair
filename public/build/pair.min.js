/*! pair 2014-03-16 */
"use strict";angular.module("app").factory("mvAuth",function(a,b,c,d){return{authenticateUser:function(e,f){var g=c.defer();return a.post("/login",{username:e,password:f}).then(function(a){if(a.data.success){var c=new d;angular.extend(c,a.data.user),b.currentUser=c,g.resolve(!0)}else g.resolve(!1)}),g.promise},createUser:function(a){var e=new d(a),f=c.defer();return e.$save().then(function(){b.currentUser=e,f.resolve()},function(a){f.reject(a.data.reason)}),f.promise},updateCurrentUser:function(a){var d=c.defer(),e=angular.copy(b.currentUser);return angular.extend(e,a),e.$update().then(function(){b.currentUser=e,d.resolve()},function(a){d.reject(a.data.reason)}),d.promise},logoutUser:function(){var d=c.defer();return a.post("/logout",{logout:!0}).then(function(){b.currentUser=void 0,d.resolve()}),d.promise},authoriseCurrentUserForRoute:function(a){return b.isAuthorised(a)?!0:c.reject("not authorised")},authoriseAuthenticatedUserForRoute:function(){return b.isAuthenticated()?!0:c.reject("not authorised")}}}),angular.module("app").factory("mvIdentity",function(a,b){var c;return a.bootstrappedUserObject&&(c=new b,angular.extend(c,a.bootstrappedUserObject)),{currentUser:c,isAuthenticated:function(){return!!this.currentUser},isAuthorised:function(a){return!!this.currentUser&&this.currentUser.roles.indexOf(a)>-1}}}),angular.module("app").controller("mvNavbarLoginCtrl",function(a,b,c,d,e){a.identity=b,a.signin=function(a,b){return d.authenticateUser(a,b).then(function(a){a?c.notify("You have been successfully signed in"):c.error("Login failed - Incorrect username or password")})},a.signout=function(){return d.logoutUser().then(function(){a.username="",a.password="",c.notify("You are now signed out"),e.path("/")})}}),angular.module("app").controller("mvProfileCtrl",function(a,b,c,d){a.email=c.currentUser.username,a.firstName=c.currentUser.firstName,a.lastName=c.currentUser.lastName,a.skills=c.currentUser.skills.join(", "),a.update=function(){var c={username:a.email,firstName:a.firstName,lastName:a.lastName,skills:a.skills.split(", ")};a.password&&a.password.length>0&&(c.password=a.password),b.updateCurrentUser(c).then(function(){d.notify("Your user profile has been updated")},function(a){d.error(a)})}}),angular.module("app").controller("mvSignupCtrl",function(a,b,c,d){a.signup=function(){var e={username:a.email,password:a.password,firstName:a.firstName,lastName:a.lastName};d.createUser(e).then(function(){b.notify("New user account created!"),c.path("/")},function(a){b.error(a)})}}),angular.module("app").factory("mvUser",function(a){var b=a("/api/users/:_id",{_id:"@id"},{update:{method:"PUT",isArray:!1}});return b.prototype.isAdmin=function(){return this.roles&&this.roles.indexOf("admin")>-1},b}),angular.module("app").controller("mvAdminUserListCtrl",function(a,b){a.users=b.query()}),angular.module("app",["ngResource","ngRoute"]),angular.module("app").config(function(a,b){b.html5Mode(!0);var c={admin:{auth:function(a){return a.authoriseCurrentUserForRoute("admin")}},user:{auth:function(a){return a.authoriseAuthenticatedUserForRoute()}}};a.when("/",{templateUrl:"/partials/main/main",controller:"mvMainCtrl"}).when("/admin/users",{templateUrl:"/partials/admin/user-list",controller:"mvAdminUserListCtrl",resolve:c.admin}).when("/signup",{templateUrl:"/partials/account/signup",controller:"mvSignupCtrl"}).when("/profile",{templateUrl:"/partials/account/profile",controller:"mvProfileCtrl",resolve:c.user}).when("/users",{templateUrl:"/partials/users/user-list",controller:"mvUserListCtrl",resolve:c.user}).when("/users/:id",{templateUrl:"/partials/users/user-detail",controller:"mvUserDetailCtrl",resolve:c.user})}),angular.module("app").run(function(a,b,c){a.$on("$routeChangeError",function(a,c,d,e){"not authorised"===e&&b.path("/")}),a.identity=c}),angular.module("app").value("mvToastr",toastr),angular.module("app").factory("mvNotifier",function(a,b){return{notify:function(c){a.success(c),b.log(c)},error:function(c){a.error(c),b.error(c)}}}),angular.module("app").controller("mvMainCtrl",function(a){a.activityFeedItems=[{text:"Something happened",published:new Date},{text:"Something else happened",published:new Date},{text:"And more stuff happened",published:new Date},{text:"More stuff",published:new Date},{text:"stuff",published:new Date}],a.user={name:"Jane Doe",points:2500,status:"available to pair now",languages:["C#","Javascript","Php"],email:"robbie@test.com"}}),angular.module("app").controller("mvUserDetailCtrl",function(a,b,c){a.user=b.get({_id:c.id})}),angular.module("app").controller("mvUserListCtrl",function(a,b){a.users=b.query(),a.sortOptions=[{value:"lastName",label:"Sort by Last Name"},{value:"status",label:"Sort by Status"},{value:"points",label:"Sort by Pair Points"}],a.sortOrder=a.sortOptions[0].value});