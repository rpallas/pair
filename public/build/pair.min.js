/*! pair 2014-04-28 */
"use strict";angular.module("app").factory("authSvc",function(a,b,c,d){return{authenticateUser:function(e,f){var g=c.defer();return a.post("/login",{username:e,password:f}).then(function(a){if(a.data.success){var c=new d;angular.extend(c,a.data.user),b.currentUser=c,g.resolve(!0)}else g.resolve(!1)}),g.promise},createUser:function(a){var e=new d(a),f=c.defer();return e.$save().then(function(){b.currentUser=e,f.resolve()},function(a){f.reject(a.data.reason)}),f.promise},updateCurrentUser:function(a){var d=c.defer(),e=angular.copy(b.currentUser);return angular.extend(e,a),e.$update().then(function(){b.currentUser=e,d.resolve()},function(a){d.reject(a.data.reason)}),d.promise},logoutUser:function(){var d=c.defer();return a.post("/logout",{logout:!0}).then(function(){b.currentUser=void 0,d.resolve()}),d.promise},authoriseCurrentUserForRoute:function(a){return b.isAuthorised(a)?!0:c.reject("not authorised")},authoriseAuthenticatedUserForRoute:function(){return b.isAuthenticated()?!0:c.reject("not authorised")}}}),angular.module("app").factory("identitySvc",function(a,b){var c;return a.bootstrappedUserObject&&(c=new b,angular.extend(c,a.bootstrappedUserObject)),{currentUser:c,isAuthenticated:function(){return!!this.currentUser},isAuthorised:function(a){return!!this.currentUser&&this.currentUser.roles.indexOf(a)>-1}}}),angular.module("app").controller("navbarLoginCtrl",function(a,b,c,d,e){function f(a){a?(e.path("/dashboard"),c.notify("You have been successfully signed in")):c.error("Login failed - Incorrect username or password")}a.identity=b,a.signin=function(a,b){return d.authenticateUser(a,b).then(f)},a.signout=function(){return d.logoutUser().then(function(){a.username="",a.password="",c.notify("You are now signed out"),e.path("/")})}}),angular.module("app").controller("profileCtrl",function(a,b,c,d){a.email=c.currentUser.username,a.displayName=c.currentUser.displayName,a.skills=c.currentUser.skills.join(", "),a.avatarUrl=c.currentUser.getProfileImage(),a.update=function(){var c={username:a.email,displayName:a.displayName,skills:a.skills.split(", ")};a.password&&a.password.length>0&&(c.password=a.password),b.updateCurrentUser(c).then(function(){d.notify("Your user profile has been updated")},function(a){d.error(a)})}}),angular.module("app").controller("signupCtrl",function(a,b,c,d){a.submitEmail=function(){var b={username:a.email};d.updateCurrentUser(b),c.path("/dashboard")},a.signup=function(){var e={username:a.email,password:a.password,displayName:a.displayName};d.createUser(e).then(function(){b.notify("New user account created!"),c.path("/")},function(a){b.error(a)})}}),angular.module("app").factory("userResource",function(a,b){var c=a("/api/users/:_id",{_id:"@id"},{update:{method:"PUT",isArray:!1}});return c.prototype.isAdmin=function(){return this.roles&&this.roles.indexOf("admin")>-1},c.prototype.getProfileImage=function(){return this.avatarUrl||b.blankProfileImage},c}),angular.module("app").controller("adminUserListCtrl",function(a,b){a.users=b.query(),a.hasUsers=function(){return a.users.length>0}}),angular.module("app",["ngResource","ngRoute"]),angular.module("app").config(function(a,b){b.html5Mode(!0);var c={admin:{auth:function(a){return a.authoriseCurrentUserForRoute("admin")}},user:{auth:function(a){return a.authoriseAuthenticatedUserForRoute()}}};a.when("/",{templateUrl:"/partials/main/main",controller:"mainCtrl"}).when("/admin/users",{templateUrl:"/partials/admin/user-list",controller:"adminUserListCtrl",resolve:c.admin}).when("/signup",{templateUrl:"/partials/account/signup",controller:"signupCtrl"}).when("/profile",{templateUrl:"/partials/account/profile",controller:"profileCtrl",resolve:c.user}).when("/users",{templateUrl:"/partials/users/user-list",controller:"userListCtrl",resolve:c.user}).when("/users/:id",{templateUrl:"/partials/users/user-detail",controller:"userDetailCtrl",resolve:c.user}).when("/users/:id/request",{templateUrl:"/partials/requests/pair-request",controller:"pairRequestCtrl",resolve:c.user}).when("/dashboard",{templateUrl:"/partials/dashboard/dashboard",controller:"dashboardCtrl",resolve:c.user}).when("/request-email",{templateUrl:"/partials/account/request-email",controller:"signupCtrl",resolve:c.user}).when("/requests",{templateUrl:"/partials/requests/request-list",controller:"requestListCtrl",resolve:c.user}).when("/requests/:id",{templateUrl:"/partials/requests/request-detail",controller:"requestDetailCtrl",resolve:c.user})}),angular.module("app").run(function(a,b,c){a.$on("$routeChangeError",function(a,c,d,e){"not authorised"===e&&b.path("/")}),a.identity=c,$(document).on("click.nav",".navbar-collapse.in",function(a){($(a.target).is("a")||$(a.target).is("button"))&&$(this).collapse("hide")})}),angular.module("app").factory("config",function(){return{blankProfileImage:"https://s3-eu-west-1.amazonaws.com/pair-app/blank-profile.png"}}),angular.module("app").value("Toastr",toastr),angular.module("app").factory("notifierSvc",function(a,b){return{notify:function(c){a.success(c),b.log(c)},error:function(c){a.error(c),b.error(c)}}}),angular.module("app").controller("dashboardCtrl",function(a,b,c,d){var e=d._;a.email=b.currentUser.username,a.displayName=b.currentUser.displayName,a.skills=b.currentUser.skills,a.status=b.currentUser.status,a.points=b.currentUser.points,a.requests=c.query({userId:b.currentUser._id,limit:5,sort:"descending"},function(a){e.each(a,function(a){a.toUser.id===b.currentUser._id?(a.direction="received",a.otherUser=a.fromUser):(a.direction="sent",a.otherUser=a.toUser)})}),a.activityFeedItems=[{text:"Something happened",published:new Date},{text:"Something else happened",published:new Date},{text:"And more stuff happened",published:new Date},{text:"More stuff",published:new Date},{text:"stuff",published:new Date}]}),angular.module("app").controller("mainCtrl",function(){}),angular.module("app").controller("pairRequestCtrl",function(a,b,c,d,e,f,g,h){a.targetUser=b.get({_id:d.id}),a.identity=f,a.requestPair=function(b){var d=e.defer(),i=new c({fromUser:{id:f.currentUser._id,displayName:f.currentUser.displayName,avatarUrl:f.currentUser.avatarUrl||h.blankProfileImage},toUser:{id:a.targetUser._id,displayName:a.targetUser.displayName,avatarUrl:a.targetUser.avatarUrl||h.blankProfileImage},message:b});return i.$save().then(function(){g.notify("Pair request sent"),d.resolve()},function(a){g.error("Error sending pair request"),d.reject(a.data.reason)}),d.promise}}),angular.module("app").controller("requestDetailCtrl",function(a,b,c){a.request=b.get({_id:c.id})}),angular.module("app").controller("requestListCtrl",function(a,b,c,d,e){function f(a,b){var d=new c;angular.extend(d,a),d.$update({state:b}).then(function(){e.notify("Request state changed to '"+b+"'"),a.state=b},function(a){e.error("Error while accepting request")})}a.requests=b.get({userId:d.currentUser._id}),a.receivedRequests=function(){return a.requests.filter(function(a){return void 0===d.currentUser?!1:a.toUser.id===d.currentUser._id})},a.hasReceivedRequests=function(){return a.receivedRequests().length>0},a.sentRequests=function(){return a.requests.filter(function(a){return void 0===d.currentUser?!1:a.fromUser.id===d.currentUser._id})},a.hasSentRequests=function(){return a.sentRequests().length>0},a.acceptRequest=function(a){f(a,"Accepted")},a.rejectRequest=function(a){f(a,"Rejected")},a.rescheduleRequest=function(a){f(a,"Reschedule")},a.deleteRequest=function(){},a.initTooltips=function(){$("[data-toggle=tooltip]").tooltip({placement:"bottom"})}}),angular.module("app").factory("requestResource",function(a){var b=a("/api/requests/:_id",{_id:"@id",state:"@state"},{update:{method:"PUT",isArray:!1}});return b}),angular.module("app").factory("userRequestResource",function(a){var b=a("/api/user/:userId/requests/:requestId",{userId:"@userId",requestId:"@requestId",limit:"@limit",sort:"@sort"},{get:{method:"GET",isArray:!0}});return b}),angular.module("app").factory("receivedRequestsResource",function(a){var b=a("/api/user/:userId/received",{userId:"@userId",limit:"@limit"},{get:{method:"GET",isArray:!0}});return b}),angular.module("app").factory("sentRequestsResource",function(a){var b=a("/api/user/:userId/sent",{userId:"@userId",limit:"@limit"},{get:{method:"GET",isArray:!0}});return b}),angular.module("app").controller("userDetailCtrl",function(a,b,c,d,e,f,g,h){a.user=b.get({_id:d.id}),a.requestPair=function(){var b=e.defer(),d=new c({fromUser:{id:f.currentUser._id,displayName:f.currentUser.displayName,avatarUrl:f.currentUser.avatarUrl||h.blankProfileImage},toUser:{id:a.user._id,displayName:a.user.displayName,avatarUrl:a.user.avatarUrl||h.blankProfileImage}});return d.$save().then(function(){g.notify("Pair request sent"),b.resolve()},function(a){g.error("Error sending pair request"),b.reject(a.data.reason)}),b.promise}}),angular.module("app").controller("userListCtrl",function(a,b,c){a.users=b.query(),a.otherUsers=function(){return a.users.filter(function(a){return a._id!==c.currentUser._id})},a.hasUsers=function(){return a.otherUsers().length>0},a.sortOptions=[{value:"displayName",label:"Sort by Display Name"},{value:"status",label:"Sort by Status"},{value:"points",label:"Sort by Pair Points"}],a.sortOrder=a.sortOptions[0].value});